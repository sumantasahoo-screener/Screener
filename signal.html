    # === Build HTML view (preserve Excel colors + show only selected columns) ===
    try:
        from openpyxl import load_workbook

        # Columns you want in HTML (edit if needed)
        DISPLAY_COLS = [
            "UNDERLYING_SYMBOL", "Signal_DATETIME", "Signal Price", "SIGNAL OPTION",
            "CALL_LTP", "PUT_LTP", "SPOT_LTP", "BASE_SIGNAL", "PRICE ACTION",
            "ACTION SCORE", "OI_IMB_SIGNAL", "OI_IMB_STRENGTH", "OI_ACTION",
            "OI_SCORE", "OI_IMB_DIRECTION", "DELTA_ZONE", "IV_ZONE", "THETA_ZONE",
            "GAMMA_ZONE", "CALL_PCT", "PUT_PCT", "OI_IMBALANCE_PCT",
            "CALL_SYMBOL", "PUT_SYMBOL", "LOT_Size", "SM_EXPIRY_DATE"
        ]

        wb2 = load_workbook(OUT, data_only=True)
        ws2 = wb2.active

        # Build header map: excel col idx -> header name
        header_names = [str(cell.value).strip() if cell.value is not None else "" for cell in ws2[1]]
        # Determine indexes for DISPLAY_COLS (preserve order in DISPLAY_COLS)
        col_index_map = {}
        for idx, h in enumerate(header_names, start=1):
            if h in DISPLAY_COLS:
                col_index_map[h] = idx

        # HTML helpers
        def _fill_to_hex(cell):
            try:
                fill = cell.fill
                if not fill or fill.fill_type is None:
                    return None
                fg = fill.fgColor
                rgb = None
                # fgColor can have rgb like 'FF4CAF50' or theme/indexed - handle common case
                if fg is None:
                    return None
                if hasattr(fg, "rgb") and fg.rgb is not None:
                    rgb = fg.rgb
                elif hasattr(fg, "index") and fg.index is not None:
                    # fallback not robust for theme/indexed; return None
                    rgb = None
                if not rgb:
                    return None
                rgb = str(rgb)
                # Remove leading alpha if present (8 chars -> take last 6)
                if len(rgb) == 8:
                    rgb = rgb[-6:]
                elif len(rgb) > 6:
                    rgb = rgb[-6:]
                return f"#{rgb}"
            except Exception:
                return None

        def _text_color_for_bg(hexcol):
            # simple brightness check: return white for dark bg, black for light bg
            try:
                if not hexcol:
                    return "#000000"
                h = hexcol.lstrip('#')
                r = int(h[0:2], 16); g = int(h[2:4], 16); b = int(h[4:6], 16)
                brightness = (r*299 + g*587 + b*114) / 1000
                return "#000000" if brightness > 150 else "#FFFFFF"
            except Exception:
                return "#000000"

        # Start table
        html_rows = []
        # header row (use DISPLAY_COLS order, but only those present)
        visible_headers = [c for c in DISPLAY_COLS if c in col_index_map]
        header_html = "<tr>" + "".join(f"<th>{h}</th>" for h in visible_headers) + "</tr>"
        html_rows.append(header_html)

        # iterate data rows
        for r_idx in range(2, ws2.max_row + 1):
            row_cells = []
            for h in visible_headers:
                c_idx = col_index_map[h]
                cell = ws2.cell(row=r_idx, column=c_idx)
                v = cell.value
                text = "" if v is None else str(v)
                bg = _fill_to_hex(cell)
                txt_color = _text_color_for_bg(bg)
                style = ""
                if bg:
                    style = f'style="background-color:{bg};color:{txt_color};padding:4px;text-align:center;"'
                else:
                    style = 'style="padding:4px;text-align:center;"'
                row_cells.append(f"<td {style}>{text}</td>")
            html_rows.append("<tr>" + "".join(row_cells) + "</tr>")

        table_html = '<table border="1" class="dataframe">' + "".join(html_rows) + "</table>"

        # read your template, substitute
        with open("signal_template.html", "r", encoding="utf-8") as f:
            tpl = f.read()
        html_out = tpl.replace("<table border="1" class="dataframe dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>UNDERLYING_SYMBOL</th>
      <th>Signal_DATETIME</th>
      <th>Signal Price</th>
      <th>SIGNAL OPTION</th>
      <th>CALL_LTP</th>
      <th>PUT_LTP</th>
      <th>SPOT_LTP</th>
      <th>BASE_SIGNAL</th>
      <th>PRICE ACTION</th>
      <th>ACTION SCORE</th>
      <th>OI_IMB_SIGNAL</th>
      <th>OI_IMB_STRENGTH</th>
      <th>OI_ACTION</th>
      <th>OI_SCORE</th>
      <th>OI_IMB_DIRECTION</th>
      <th>DELTA_ZONE</th>
      <th>IV_ZONE</th>
      <th>THETA_ZONE</th>
      <th>GAMMA_ZONE</th>
      <th>CALL_OI_CHANGE</th>
      <th>PUT_OI_CHANGE</th>
      <th>CALL_PCT</th>
      <th>PUT_PCT</th>
      <th>OI_IMBALANCE_PCT</th>
      <th>CALL_SYMBOL</th>
      <th>PUT_SYMBOL</th>
      <th>LOT_Size</th>
      <th>UNDERLYING_SECURITY_ID</th>
      <th>SM_EXPIRY_DATE</th>
      <th>MISSING_INDICATORS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ASHOKLEY</td>
      <td>2025-12-11 16:23:25</td>
      <td>3.68</td>
      <td>160-CE</td>
      <td>3.68</td>
      <td>2.86</td>
      <td>160.33</td>
      <td>Bullish</td>
      <td>NO-TRADE</td>
      <td>U60</td>
      <td>100.0% - Buy</td>
      <td>Solid</td>
      <td>Short Cover</td>
      <td>3</td>
      <td>Buy</td>
      <td>PE DELTA 43%</td>
      <td>PE IV 54%</td>
      <td>PE THETA 41%</td>
      <td>PE GAMMA 46%</td>
      <td>-1285000</td>
      <td>1625000</td>
      <td>44.2</td>
      <td>55.8</td>
      <td>100.0</td>
      <td>ASHOKLEY-Dec2025-160-CE - ATM</td>
      <td>ASHOKLEY-Dec2025-160-PE - ATM</td>
      <td>5000</td>
      <td>212</td>
      <td>2025-12-30</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>ASIANPAINT</td>
      <td>2025-12-11 16:23:25</td>
      <td>40.00</td>
      <td>2780-PE</td>
      <td>48.40</td>
      <td>40.00</td>
      <td>2779.40</td>
      <td>Bearish</td>
      <td>DOWN</td>
      <td>D70</td>
      <td>100.0% - Sell</td>
      <td>Solid</td>
      <td>Short Buildup</td>
      <td>4</td>
      <td>Sell</td>
      <td>PE DELTA 45%</td>
      <td>PE IV 53%</td>
      <td>PE THETA 36%</td>
      <td>PE GAMMA 48%</td>
      <td>340750</td>
      <td>-51500</td>
      <td>86.9</td>
      <td>13.1</td>
      <td>100.0</td>
      <td>ASIANPAINT-Dec2025-2780-CE - ATM</td>
      <td>ASIANPAINT-Dec2025-2780-PE - ATM</td>
      <td>250</td>
      <td>236</td>
      <td>2025-12-30</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>HINDUNILVR</td>
      <td>2025-12-11 16:23:25</td>
      <td>19.95</td>
      <td>2300-PE</td>
      <td>38.70</td>
      <td>19.95</td>
      <td>2305.60</td>
      <td>Bearish</td>
      <td>NO-TRADE</td>
      <td>NO-TRADE</td>
      <td>100.0% - Sell</td>
      <td>Solid</td>
      <td>Long Buildup</td>
      <td>4</td>
      <td>Sell</td>
      <td>PE DELTA 39%</td>
      <td>PE IV 53%</td>
      <td>PE THETA 31%</td>
      <td>PE GAMMA 48%</td>
      <td>50100</td>
      <td>-600</td>
      <td>98.8</td>
      <td>1.2</td>
      <td>100.0</td>
      <td>HINDUNILVR-Dec2025-2300-CE - ATM</td>
      <td>HINDUNILVR-Dec2025-2300-PE - ATM</td>
      <td>300</td>
      <td>1394</td>
      <td>2025-12-30</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>ICICIBANK</td>
      <td>2025-12-11 16:23:25</td>
      <td>13.80</td>
      <td>1360-PE</td>
      <td>21.25</td>
      <td>13.80</td>
      <td>1360.00</td>
      <td>Bearish</td>
      <td>NO-TRADE</td>
      <td>D60</td>
      <td>44.9% - Sell</td>
      <td>No-trade</td>
      <td>Short Buildup</td>
      <td>4</td>
      <td>Sell</td>
      <td>PE DELTA 43%</td>
      <td>PE IV 51%</td>
      <td>PE THETA 30%</td>
      <td>PE GAMMA 49%</td>
      <td>1133300</td>
      <td>431200</td>
      <td>72.4</td>
      <td>27.6</td>
      <td>44.9</td>
      <td>ICICIBANK-Dec2025-1360-CE - ATM</td>
      <td>ICICIBANK-Dec2025-1360-PE - ATM</td>
      <td>700</td>
      <td>4963</td>
      <td>2025-12-30</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>NIFTY</td>
      <td>2025-12-11 16:23:25</td>
      <td>115.60</td>
      <td>25900-CE</td>
      <td>115.60</td>
      <td>86.20</td>
      <td>25898.55</td>
      <td>Bullish</td>
      <td>UP</td>
      <td>U80</td>
      <td>100.0% - Buy</td>
      <td>Solid</td>
      <td>Short Cover</td>
      <td>3</td>
      <td>Buy</td>
      <td>PE DELTA 45%</td>
      <td>PE IV 51%</td>
      <td>PE THETA 32%</td>
      <td>PE GAMMA 49%</td>
      <td>-10730100</td>
      <td>14024250</td>
      <td>43.3</td>
      <td>56.7</td>
      <td>100.0</td>
      <td>NIFTY-Dec2025-25900-CE - ATM</td>
      <td>NIFTY-Dec2025-25900-PE - ATM</td>
      <td>75</td>
      <td>26000</td>
      <td>2025-12-16</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>SBIN</td>
      <td>2025-12-11 16:23:25</td>
      <td>12.75</td>
      <td>965-CE</td>
      <td>12.75</td>
      <td>12.85</td>
      <td>963.25</td>
      <td>Bullish</td>
      <td>NO-TRADE</td>
      <td>NO-TRADE</td>
      <td>6.3% - Buy</td>
      <td>No-trade</td>
      <td>Long Buildup</td>
      <td>4</td>
      <td>Buy</td>
      <td>PE DELTA 46%</td>
      <td>PE IV 55%</td>
      <td>PE THETA 36%</td>
      <td>PE GAMMA 45%</td>
      <td>-874500</td>
      <td>-771000</td>
      <td>53.1</td>
      <td>46.9</td>
      <td>6.3</td>
      <td>SBIN-Dec2025-965-CE - ATM</td>
      <td>SBIN-Dec2025-965-PE - ATM</td>
      <td>750</td>
      <td>3045</td>
      <td>2025-12-30</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>", table_html)

        # write to your repo output path (same as before)
        out_path = "D:/ScreenerGIT/Screener/signal.html"
        with open(out_path, "w", encoding="utf-8") as f:
            f.write(html_out)

    except Exception as e:
        print("HTML build error:", e)
